{"title":"V2Ray+WebSocket+TLS+Nginx","date":"2020-09-14T17:00:00.000Z","date_formatted":{"ll":"2020年9月14日","L":"2020/09/14","MM-DD":"09-14"},"author":"Nanzet","link":"2020/09/14/V2Ray+WebSocket+TLS+Nginx","tags":["v2ray"],"categories":["技术"],"updated":"2022-11-19T15:43:12.598Z","content":"<h4 id=\"1.-v2ray服务端配置参考\">1. v2ray服务端配置参考<a title=\"#1.-v2ray服务端配置参考\" href=\"#1.-v2ray服务端配置参考\"></a></h4>\n<pre><code class=\"language-json\">&#123;\n  &quot;log&quot;: &#123;\n    &quot;loglevel&quot;: &quot;warning&quot;,\n    &quot;access&quot;: &quot;/var/log/v2ray/access.log&quot;,\n    &quot;error&quot;: &quot;/var/log/v2ray/error.log&quot;\n  &#125;,\n  &quot;inbounds&quot;: [\n    &#123;\n      &quot;port&quot;: 15421,    # 改成自己的端口，注意防火墙开启15421端口\n      &quot;listen&quot;: &quot;127.0.0.1&quot;,\n      &quot;protocol&quot;: &quot;vmess&quot;,\n      &quot;settings&quot;: &#123;\n        &quot;clients&quot;: [\n          &#123;\n            &quot;id&quot;: &quot;xxxxxxxxx&quot;,    # 改成自己的id\n            &quot;alterId&quot;: 64\n          &#125;\n        ]\n      &#125;,\n      &quot;streamSettings&quot;: &#123;\n        &quot;network&quot;: &quot;ws&quot;,\n        &quot;wsSettings&quot;: &#123;\n          &quot;path&quot;: &quot;/ray&quot;    # /ray 路径需要和v2ray客户端、nignx配置里保持一致，可将ray改成一个uuid\n        &#125;\n      &#125;\n    &#125;\n  ],\n  &quot;outbounds&quot;: [\n    &#123;\n      &quot;protocol&quot;: &quot;freedom&quot;,\n      &quot;settings&quot;: &#123;&#125;,\n      &quot;tag&quot;: &quot;direct&quot;\n    &#125;,\n    &#123;\n      &quot;protocol&quot;: &quot;freedom&quot;,\n      &quot;settings&quot;: &#123;\n        &quot;domainStrategy&quot;: &quot;UseIPv4&quot;\n      &#125;,\n      &quot;tag&quot;: &quot;ip4-out&quot;\n    &#125;,\n    &#123;\n      &quot;protocol&quot;: &quot;blackhole&quot;,\n      &quot;settings&quot;: &#123;&#125;,\n      &quot;tag&quot;: &quot;blocked&quot;\n    &#125;\n  ],\n  &quot;routing&quot;: &#123;\n    &quot;rules&quot;: [\n      &#123;\n        &quot;type&quot;: &quot;field&quot;,\n        &quot;domain&quot;: [&quot;domain:google.com&quot;],\n        &quot;outboundTag&quot;: &quot;ip4-out&quot;\n      &#125;,\n      &#123;\n        &quot;type&quot;: &quot;field&quot;,\n        &quot;ip&quot;: [\n          &quot;0.0.0.0/8&quot;,\n          &quot;10.0.0.0/8&quot;,\n          &quot;100.64.0.0/10&quot;,\n          &quot;127.0.0.0/8&quot;,\n          &quot;169.254.0.0/16&quot;,\n          &quot;172.16.0.0/12&quot;,\n          &quot;192.0.0.0/24&quot;,\n          &quot;192.0.2.0/24&quot;,\n          &quot;192.168.0.0/16&quot;,\n          &quot;198.18.0.0/15&quot;,\n          &quot;198.51.100.0/24&quot;,\n          &quot;203.0.113.0/24&quot;,\n          &quot;::1/128&quot;,\n          &quot;fc00::/7&quot;,\n          &quot;fe80::/10&quot;\n        ],\n        &quot;outboundTag&quot;: &quot;blocked&quot;\n      &#125;\n    ]\n  &#125;\n&#125;\n</code></pre>\n<p> 重启v2ray服务端：</p>\n<pre><code class=\"language-bash\">systemctl restart v2ray\n</code></pre>\n<h4 id=\"2.-安装nginx\">2. 安装Nginx<a title=\"#2.-安装nginx\" href=\"#2.-安装nginx\"></a></h4>\n<p>参考：<a href=\"https://www.cnblogs.com/gede/p/11011693.html\" target=\"_blank\">https://www.cnblogs.com/gede/p/11011693.html</a></p>\n<h5 id=\"2.1.-执行安装命令\">2.1. 执行安装命令<a title=\"#2.1.-执行安装命令\" href=\"#2.1.-执行安装命令\"></a></h5>\n<pre><code class=\"language-bash\">sudo apt-get install nginx\n</code></pre>\n<h5 id=\"2.2.-查看版本检测是否安装成功\">2.2. 查看版本检测是否安装成功<a title=\"#2.2.-查看版本检测是否安装成功\" href=\"#2.2.-查看版本检测是否安装成功\"></a></h5>\n<pre><code class=\"language-bash\">nginx -v\n</code></pre>\n<h4 id=\"3.-配置nginx\">3. 配置Nginx<a title=\"#3.-配置nginx\" href=\"#3.-配置nginx\"></a></h4>\n<h5 id=\"3.1.--切换到nginx的配置文件夹目录\">3.1.  切换到nginx的配置文件夹目录<a title=\"#3.1.--切换到nginx的配置文件夹目录\" href=\"#3.1.--切换到nginx的配置文件夹目录\"></a></h5>\n<pre><code class=\"language-bash\">cd /etc/nginx/conf.d\n</code></pre>\n<h5 id=\"3.2-申请免费ssl证书\">3.2 申请免费ssl证书<a title=\"#3.2-申请免费ssl证书\" href=\"#3.2-申请免费ssl证书\"></a></h5>\n<p>**方案一：**可以使用在TLS教程里生成的证书（<a href=\"https://guide.v2fly.org/advanced/tls.html\" target=\"_blank\">传送门</a>）</p>\n<p>**方案二：**使用certbot自动签一个let’s encrypt证书</p>\n<p> 例如我的系统是ubuntu 16.04，网站运行在nignx上（其他版本请在页面自己选择），签发证书参考：<a href=\"https://certbot.eff.org/lets-encrypt/ubuntuxenial-nginx\" target=\"_blank\">https://certbot.eff.org/lets-encrypt/ubuntuxenial-nginx</a></p>\n<p> 注意：第4步选择just get a certificate即可。</p>\n<p> 英文教程看起来费劲的话，参考：<a href=\"https://www.jianshu.com/p/b47d862bceeb\" target=\"_blank\">Ubuntu免费ssl证书（Let’s Encrypt）配置</a>（里面的配置文件内容不用参考）</p>\n<p> 证书生成成功的提示信息，可以查看保存的位置：</p>\n<pre><code class=\"language-bash\">IMPORTANT NOTES:\n- Congratulations! Your certificate and chain have been saved at:\n   /etc/letsencrypt/live/yourdomain.com/fullchain.pem\n   Your key file has been saved at:\n   /etc/letsencrypt/live/yourdomain.com/privkey.pem\n   Your cert will expire on 2020-11-10. To obtain a new or tweaked\n   version of this certificate in the future, simply run certbot\n   again. To non-interactively renew *all* of your certificates, run\n   &quot;certbot renew&quot;\n- Your account credentials have been saved in your Certbot\n   configuration directory at /etc/letsencrypt. You should make a\n   secure backup of this folder now. This configuration directory will\n   also contain certificates and private keys obtained by Certbot so\n   making regular backups of this folder is ideal.\n- If you like Certbot, please consider supporting our work by:\n\n\n   Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate\n   Donating to EFF:                    https://eff.org/donate-le\n</code></pre>\n<h5 id=\"3.3-添加对应网站的配置文件\">3.3 添加对应网站的配置文件<a title=\"#3.3-添加对应网站的配置文件\" href=\"#3.3-添加对应网站的配置文件\"></a></h5>\n<p> 常用的命名规则：项目名+二级域名+端口.conf，例如：</p>\n<pre><code class=\"language-bash\">vim v2ray-yourdomain-15421.conf\n</code></pre>\n<p> 配置内容：</p>\n<pre><code class=\"language-bash\">server &#123;\n  listen  443 ssl;    # 注意防火墙开启443端口\n  ssl on;\n  ssl_certificate       /etc/letsencrypt/live/yourdomain.com/fullchain.pem;    # 你的ssl证书\n  ssl_certificate_key   /etc/letsencrypt/live/yourdomain.com/privkey.pem;    # 你的ssl key\n  ssl_protocols         TLSv1 TLSv1.1 TLSv1.2;\n  ssl_ciphers           HIGH:!aNULL:!MD5;\n  server_name           yourdomain.com;    # 你的网站域名\n        location /ray &#123;    # /ray 路径需要和v2ray服务器端，客户端保持一致\n        proxy_redirect off;\n        proxy_pass http://127.0.0.1:15421;    # 此IP地址和端口需要和v2ray服务器保持一致\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection &quot;upgrade&quot;;\n        proxy_set_header Host $http_host;\n\n\n        # Show realip in v2ray access.log\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        &#125;\n&#125;\n</code></pre>\n<p> 保存配置文件后，检查配置是否有错误：</p>\n<pre><code class=\"language-bash\">nginx -t\n</code></pre>\n<p><img src=\"https://raw.githubusercontent.com/Nanzet/nanzet-imgs/master/images/20200914173414.jpg\" alt=\"\" loading=\"lazy\" class=\"φbp\"></p>\n<p> 重启nginx使配置文件生效：</p>\n<pre><code class=\"language-bash\">service nginx restart\n</code></pre>\n<h4 id=\"4.-v2ray客户端配置参考\">4. v2ray客户端配置参考<a title=\"#4.-v2ray客户端配置参考\" href=\"#4.-v2ray客户端配置参考\"></a></h4>\n<p>**方案一：**V2Ray客户端配置文件，以服务形式运行：</p>\n<pre><code class=\"language-json\">&#123;\n    &quot;inbounds&quot;: [\n      &#123;\n        &quot;port&quot;: 1080,\n        &quot;listen&quot;: &quot;127.0.0.1&quot;,\n        &quot;protocol&quot;: &quot;socks&quot;,\n        &quot;sniffing&quot;: &#123;\n          &quot;enabled&quot;: true,\n          &quot;destOverride&quot;: [&quot;http&quot;, &quot;tls&quot;]\n        &#125;,\n        &quot;settings&quot;: &#123;\n          &quot;auth&quot;: &quot;noauth&quot;,\n          &quot;udp&quot;: false\n        &#125;\n      &#125;\n    ],\n    &quot;outbounds&quot;: [\n      &#123;\n        &quot;protocol&quot;: &quot;vmess&quot;,\n        &quot;settings&quot;: &#123;\n          &quot;vnext&quot;: [\n            &#123;\n              &quot;address&quot;: &quot;yourdomain.com&quot;,\n              &quot;port&quot;: 443,\n              &quot;users&quot;: [\n                &#123;\n                  &quot;id&quot;: &quot;xxxxxxxx,\n                  &quot;alterId&quot;: 64\n                &#125;\n              ]\n            &#125;\n          ]\n        &#125;,\n        &quot;streamSettings&quot;: &#123;\n          &quot;network&quot;: &quot;ws&quot;,\n          &quot;security&quot;: &quot;tls&quot;,\n          &quot;wsSettings&quot;: &#123;\n            &quot;path&quot;: &quot;/ray&quot;    # /ray 路径需要和v2ray服务器端，nginx配置里保持一致\n          &#125;\n        &#125;\n      &#125;\n    ]\n  &#125;\n</code></pre>\n<p>**方案二：**下载Windows客户端–V2rayN（新手下载.zip包）（推荐）</p>\n<p> 打开软件，点击：服务器→添加[VMess]服务器：</p>\n<p><img src=\"https://raw.githubusercontent.com/Nanzet/nanzet-imgs/master/images/20200914172245.jpg\" alt=\"\" loading=\"lazy\" class=\"φbp\"></p>\n<p> 填上你设置的对应数据，如服务器ip、端口、UUID（服务端和客户端必须一致），加密方式一般为aes-128-gcm,协议为ws,伪装域名留空，路径为/ray，开启tls和不安全传输，设置完保存。</p>\n<p> 右键V2RayN的系统栏小图标，点击启用Http代理，Http代理模式选择第二个PAC模式，最后再打开V2RayN软件面板，在检查更新里选择更新PAC。到此，V2Ray就全部配置完成了。</p>\n<p> 谷歌浏览器测试一下：</p>\n<p><img src=\"https://raw.githubusercontent.com/Nanzet/nanzet-imgs/master/images/20200914173737.jpg\" alt=\"\" loading=\"lazy\" class=\"φbp\"></p>\n","prev":{"title":"VMware中虚拟机扩容","link":"2020/09/16/VMware中虚拟机扩容"},"next":{"title":"Django--使用snowflake自定义生成主键ID替换数据库主键自增ID","link":"2020/07/14/简单—Django修改自增主键id为使用snowflake自定义生成主键id"},"plink":"https://nanzet.cn/2020/09/14/V2Ray+WebSocket+TLS+Nginx/","reward":true,"copyright":{"author":"Nanzet","link":"<a href=\"https://nanzet.cn/2020/09/14/V2Ray+WebSocket+TLS+Nginx/\" title=\"V2Ray+WebSocket+TLS+Nginx\">https://nanzet.cn/2020/09/14/V2Ray+WebSocket+TLS+Nginx/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"},"reading_time":"1072 字约 7 分钟"}